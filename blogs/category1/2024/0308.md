---
title: Vue2æ ¸å¿ƒæºç è§£æ
date: 2024-03-08
tags:
  - sourceCode
categories:
  - å‰ç«¯å¼€å‘
---

## Flow

### æ˜¯ä»€ä¹ˆ
   
ä¸€ç§é™æ€æ£€æŸ¥å·¥å…·ï¼Œå·¥ä½œä¸­ä¸ä¼šç”¨åˆ°ï¼Œç±»ä¼¼äºTypescriptã€‚[Flowå®˜ç½‘](https://flow.org/en/docs/getting-started/)

### ä½¿ç”¨flowçš„åŸå› 

- Jsæ˜¯ä¸€ä¸ªåŠ¨æ€ç±»å‹è¯­è¨€ï¼Œçµæ´»çš„èƒŒåå¸¦æ¥çš„æ˜¯éš¾ä»¥å¯»æ‰¾çš„bug;
- ç±»å‹æ£€æŸ¥æ—¶å½“å‰åŠ¨æ€ç±»å‹è¯­è¨€å‘å±•çš„è¶‹åŠ¿ï¼Œå¸®åŠ©å¼€å‘è€…åœ¨ç¼–è¯‘æ—¶å‘ç°ç”±äºç±»å‹é”™è¯¯å¼•èµ·çš„bug;
- é¡¹ç›®è¶Šå¤æ‚è¶Šéœ€è¦é€šè¿‡å·¥å…·çš„æ‰‹æ®µæ¥ä¿è¯é¡¹ç›®çš„ç»´æŠ¤å’Œä»£ç çš„å¯è¯»æ€§ã€‚


:::info
å¯ä»¥çœ‹ä¸€ä¸‹å°¤é›¨æºªæœ¬äººçš„è§£é‡Šï¼š[çŸ¥ä¹](https://www.zhihu.com/question/46397274/answer/101193678):

1. Vue 2.0 æœ¬èº«åœ¨åˆæœŸçš„å¿«é€Ÿè¿­ä»£é˜¶æ®µæ˜¯ç”¨ ES2015 å†™çš„ï¼Œæ•´ä¸ªæ„å»ºå·¥å…·é“¾ä¹Ÿæ²¿ç”¨äº† Vue 1.x çš„åŸºäº ES ç”Ÿæ€çš„ä¸€å¥—ï¼ˆBabel, ESLint, Webpack, Rollup...)
2. Babelå’ŒESlintéƒ½æœ‰å¯¹åº”çš„Flowæ’ä»¶ä»¥åŠæ”¯æŒçš„è¯­æ³•ã€‚

:::

### Flow åœ¨ Vue.js æºç ä¸­çš„åº”ç”¨

åœ¨Vue2çš„æ›´æ—©çš„ç‰ˆæœ¬ä¸­ï¼Œ[link](https://github.com/vuejs/vue/blob/2.6/.flowconfig),ä¸»ç›®å½•ä¸‹æœ‰` .flowconfig `æ–‡ä»¶ï¼Œç”¨äºé…ç½®Flow.

Flowçš„`libdef`å¯ä»¥ç”¨äºè¯†åˆ«ç¬¬ä¸‰åº“æˆ–è‡ªå®šä¹‰ç±»å‹ã€‚

## æºç å­¦ä¹ æ€è·¯

1. äº†è§£æ ¸å¿ƒæµç¨‹APIï¼ŒæŠŠåº“çš„APIç”¨ç†Ÿï¼ˆé¡ºè—¤æ‘¸ç“œï¼‰
2. æ•´ä½“æ‰§è¡Œæµç¨‹ï¼Œï¼ˆlodashã€underscoreç­‰å·¥å…·åº“é™¤å¤–,æ— å¤ªå¤šå­¦ä¹ å‚è€ƒæ„ä¹‰ï¼‰ï¼Œå¦‚ï¼š
    - webpack/vite/gulpï¼šä»å¯åŠ¨åˆ°æ‰“åŒ…è¾“å‡ºçš„æµç¨‹
    - Vue2ï¼šVue2ä»ç¼–è¯‘ => åˆå§‹åŒ– => è§¦å‘æ›´æ–° => å¸è½½çš„æµç¨‹
3. çœ‹package.jsonï¼Œçœ‹ä¾èµ–å’Œå‘½ä»¤

## Vueçš„ç›®å½•ç»“æ„è®¾è®¡
[æºç ](https://github.com/vuejs/vue)`srcä¸‹`:

| æ–‡ä»¶å¤¹ | å†…å®¹ |
|-------|-------|
| compiler | ç¼–è¯‘ç›¸å…³ |
| core | æ ¸å¿ƒä»£ç  | 
| platforms | è§£å†³è·¨å¹³å° | 
| server | æœåŠ¡ç«¯æ¸²æŸ“ | 
| sfc | .vueæ–‡ä»¶è§£æ | 
| shared | å…±äº«ä»£ç  | 

### compiler

> è¡¥å……çŸ¥è¯†ï¼šç¼–è¯‘å¯ä»¥åœ¨æ„å»ºæ—¶ï¼ˆå€ŸåŠ©webpackã€vue-loaderç­‰è¾…åŠ©å·¥å…·æ’ä»¶ï¼‰ï¼Œä¹Ÿå¯ä»¥åœ¨è¿è¡Œæ—¶ä½¿ç”¨åŒ…å«æ„å»ºåŠŸèƒ½çš„Vue.jsã€‚ç¼–è¯‘æ—¶ä¸€é¡¹è€—æ€§èƒ½çš„å·¥ä½œï¼Œæ‰€ä»¥æ¨èå‰è€…â€”â€”â€”â€”ç¦»çº¿ç¼–è¯‘ã€‚ï¼ˆæœ¬ç¯‡æ–‡ç« ä¸­æœç´¢ğŸ‘ºï¼‰

Vue.jsæ‰€æœ‰ç¼–è¯‘éƒ¨åˆ†çš„ä»£ç ã€‚åŒ…æ‹¬å°†æ¨¡æ¿è§£ææˆastè¯­æ³•æ ‘ï¼Œastè¯­æ³•æ ‘ä¼˜åŒ–ï¼Œä»£ç ç”ŸæˆåŠŸèƒ½ï¼šğŸ°

- `vue2`ä¸­æ˜¯é€šè¿‡æ­£åˆ™æ–¹å¼å®ç°ï¼Œ`vue3`æ›´åŠ ä¸¥è°¨ï¼šé€šè¿‡çŠ¶æ€æœºåˆ¶æ¥åštokensçš„è§£æï¼Œè¯æ³•è¯­æ³•åˆ†æï¼ˆä¹ŸåŒ…æ‹¬éƒ¨åˆ†æ­£åˆ™ï¼‰ï¼›
- compiler/parserè½¬æ¢ => compiler/directive ASTè§£æ => compiler/codergen ç”Ÿæˆï¼›
- å®Œæ•´çš„ç¼–è¯‘è¿‡ç¨‹ï¼šå°†ä»£ç è½¬æˆ => AST => ç›®æ ‡AST => ç”Ÿæˆä»£ç 


### core 

<xicons icon="Star" /> æ ¸å¿ƒä»£ç ï¼ŒVue.jsçš„çµé­‚ã€‚

- core/observer å“åº”å¼éƒ¨åˆ†ï¼Œdep.tsä¾¦å¬ä¾èµ–å†…å®¹ï¼Œscheduler.tsè°ƒåº¦
- core/instance ç”Ÿå‘½å‘¨æœŸã€proxyã€åˆå§‹åŒ–æŒ‚è½½ç­‰
- core/vdom è™šæ‹Ÿdomç­‰

### platforms

Vue.jsæ˜¯è·¨å¹³å°çš„ç±»`MVVM`æ¡†æ¶ï¼Œå¯ä»¥è·‘åœ¨ web ä¸Šï¼Œä¹Ÿå¯ä»¥é…åˆ weex è·‘åœ¨ native å®¢æˆ·ç«¯ä¸Šã€‚å¤šç«¯é€‚é…å¤„ç†ï¼Œéé‡ç‚¹ã€‚

![](https://cetacea-1304984885.cos.ap-shanghai.myqcloud.com/pieces/Snipaste_2024-03-15_18-49-48.jpg)

### server

- Vue2 æ”¯æŒäº†æœåŠ¡ç«¯æ¸²æŸ“ï¼Œè¿™ä¸ªç›®å½•ä¸‹æ˜¯æ‰€æœ‰æœåŠ¡ç«¯æ¸²æŸ“çš„é€»è¾‘ï¼›
- è¿™ä¸ªæ–‡ä»¶å¤¹ä¸‹çš„ä»£ç  æ˜¯è·‘åœ¨æœåŠ¡ç«¯çš„ `Node.js`ï¼Œä¸æ˜¯è·‘åœ¨æµè§ˆå™¨ç«¯çš„vue.js;
- æœåŠ¡ç«¯æ¸²æŸ“çš„ä¸»è¦å·¥ä½œæ˜¯ å°†ç»„ä»¶æ¸²æŸ“ä¸º æœåŠ¡ç«¯çš„HTMLå­—ç¬¦ä¸²ï¼Œå°†ä»–ä»¬ç›´æ¥å‘é€åˆ°æµè§ˆå™¨ï¼Œæœ€å`é™æ€æ ‡è®°`æ··åˆä¸ºå®¢æˆ·ç«¯ä¸Šå®Œå…¨äº¤äº’çš„åº”ç”¨ç¨‹åºã€‚

### sfc

æŠŠ`.vue`æ–‡ä»¶å†…å®¹è§£ææˆä¸€ä¸ª JS å¯¹è±¡ã€‚

### shared

å®šä¹‰ä¸€äº›å·¥å…·æ–¹æ³•ï¼Œè¢«æµè§ˆå™¨å’ŒæœåŠ¡ç«¯çš„Vue.jså…±äº«ã€‚å¦‚ç”Ÿå‘½å‘¨æœŸhooksç­‰ã€‚

## Vueæºç æ„å»º

### æ„å»ºè„šæœ¬å’Œè¿‡ç¨‹

Vue.js æºç æ˜¯åŸºäº `Rollup` æ„å»ºçš„ï¼Œå®ƒçš„æ„å»ºç›¸å…³é…ç½®éƒ½åœ¨ scripts ç›®å½•ä¸‹ã€‚

- å½“åœ¨å‘½ä»¤è¡Œè¿è¡Œ `npm run build` çš„æ—¶å€™ï¼Œå®é™…ä¸Šå°±ä¼šæ‰§è¡Œ node scripts/build.js

```js
//package.json
"build": "node scripts/build.js",
"build:ssr": "npm run build -- web-runtime-cjs,web-server-renderer",
"build:weex": "npm run build -- weex",
```

- `scripts/build.js`ï¼šå…ˆä»é…ç½®æ–‡ä»¶è¯»å–é…ç½®ï¼Œå†é€šè¿‡å‘½ä»¤è¡Œå‚æ•°å¯¹æ„å»ºé…ç½®åšè¿‡æ»¤ï¼Œè¿™æ ·å°±å¯ä»¥æ„å»ºå‡ºä¸åŒç”¨é€”çš„ Vue.js äº†
```js
let builds = require('./config').getAllBuilds()

// filter builds via command line arg
if (process.argv[2]) {
  const filters = process.argv[2].split(',')
  builds = builds.filter(b => {
    return filters.some(f => b.output.file.indexOf(f) > -1 || b._name.indexOf(f) > -1)
  })
} else {
  // filter out weex builds by default
  builds = builds.filter(b => {
    return b.output.file.indexOf('weex') === -1
  })
}

build(builds)
```
- æ¥ä¸‹æ¥æˆ‘ä»¬çœ‹ä¸€ä¸‹é…ç½®æ–‡ä»¶ï¼Œåœ¨ `scripts/config.js` ä¸­ï¼š
```js
const builds = {
  // Runtime only (CommonJS). Used by bundlers e.g. Webpack & Browserify
  'web-runtime-cjs': {
    entry: resolve('web/entry-runtime.js'),
    dest: resolve('dist/vue.runtime.common.js'),
    format: 'cjs',
    banner
  },
  // Runtime+compiler CommonJS build (CommonJS)
  'web-full-cjs': {
    entry: resolve('web/entry-runtime-with-compiler.js'),
    dest: resolve('dist/vue.common.js'),
    format: 'cjs',
    alias: { he: './entity-decoder' },
    banner
  },
  // Runtime only (ES Modules). Used by bundlers that support ES Modules,
  // e.g. Rollup & Webpack 2
  'web-runtime-esm': {
    entry: resolve('web/entry-runtime.js'),
    dest: resolve('dist/vue.runtime.esm.js'),
    format: 'es',
    banner
  },
  // Runtime+compiler CommonJS build (ES Modules)
  'web-full-esm': {
    entry: resolve('web/entry-runtime-with-compiler.js'),
    dest: resolve('dist/vue.esm.js'),
    format: 'es',
    alias: { he: './entity-decoder' },
    banner
  },
  // runtime-only build (Browser)
  'web-runtime-dev': {
    entry: resolve('web/entry-runtime.js'),
    dest: resolve('dist/vue.runtime.js'),
    format: 'umd',
    env: 'development',
    banner
  },
  // runtime-only production build (Browser)
  'web-runtime-prod': {
    entry: resolve('web/entry-runtime.js'),
    dest: resolve('dist/vue.runtime.min.js'),
    format: 'umd',
    env: 'production',
    banner
  },
  // Runtime+compiler development build (Browser)
  'web-full-dev': {
    entry: resolve('web/entry-runtime-with-compiler.js'),
    dest: resolve('dist/vue.js'),
    format: 'umd',
    env: 'development',
    alias: { he: './entity-decoder' },
    banner
  },
  // Runtime+compiler production build  (Browser)
  'web-full-prod': {
    entry: resolve('web/entry-runtime-with-compiler.js'),
    dest: resolve('dist/vue.min.js'),
    format: 'umd',
    env: 'production',
    alias: { he: './entity-decoder' },
    banner
  },
}
/*è¿™é‡Œåˆ—ä¸¾äº†ä¸€äº› Vue.js æ„å»ºçš„é…ç½®ï¼Œå¯¹äºå•ä¸ªé…ç½®ï¼Œå®ƒæ˜¯éµå¾ª Rollup çš„æ„å»ºè§„åˆ™çš„ã€‚
å…¶ä¸­ entry å±æ€§è¡¨ç¤ºæ„å»ºçš„å…¥å£ JS æ–‡ä»¶åœ°å€ï¼Œdest å±æ€§è¡¨ç¤ºæ„å»ºåçš„ JS æ–‡ä»¶åœ°å€ã€‚
format å±æ€§è¡¨ç¤ºæ„å»ºçš„æ ¼å¼ï¼Œcjs è¡¨ç¤ºæ„å»ºå‡ºæ¥çš„æ–‡ä»¶éµå¾ª CommonJS è§„èŒƒï¼Œ
es è¡¨ç¤ºæ„å»ºå‡ºæ¥çš„æ–‡ä»¶éµå¾ª ES Module è§„èŒƒã€‚ umd è¡¨ç¤ºæ„å»ºå‡ºæ¥çš„æ–‡ä»¶éµå¾ª UMD è§„èŒƒã€‚*/
```
- ç»è¿‡ Rollup çš„æ„å»ºæ‰“åŒ…åï¼Œæœ€ç»ˆä¼šåœ¨ dist ç›®å½•ä¸‹ç”Ÿæˆ dist/vue.runtime.common.dev.jsã€‚

### Runtime Only VS Runtime + Compiler ğŸ‘º

vue-cli å»åˆå§‹åŒ–æˆ‘ä»¬çš„ Vue.js é¡¹ç›®çš„æ—¶å€™ä¼šè¯¢é—®æˆ‘ä»¬ç”¨ `Runtime Only` ç‰ˆæœ¬çš„è¿˜æ˜¯ `Runtime + Compiler` ç‰ˆæœ¬ã€‚ä¸‹é¢æˆ‘ä»¬æ¥å¯¹æ¯”è¿™ä¸¤ä¸ªç‰ˆæœ¬ã€‚

- Runtime Only: ä½¿ç”¨æ­¤ç‰ˆæœ¬çš„Vue.js,éœ€å€ŸåŠ© webpack çš„ vue-loader å·¥å…·æŠŠ `.vue`æ–‡ä»¶ç¼–è¯‘æˆ JS, å› ä¸ºæ˜¯åœ¨ç¼–è¯‘é˜¶æ®µåšçš„ï¼Œæ‰€ä»¥ä»£ç ä½“ç§¯æ›´è½»ï¼›

- Runtime + Compilerï¼šå¦‚æœæ²¡æœ‰å¯¹ä»£ç åšé¢„ç¼–è¯‘ï¼Œä½†åˆä½¿ç”¨äº† Vue çš„ template å±æ€§å¹¶ä¼ å…¥ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œåˆ™éœ€è¦åœ¨å®¢æˆ·ç«¯ç¼–è¯‘æ¨¡æ¿ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š
  ```js
  // éœ€è¦ç¼–è¯‘å™¨çš„ç‰ˆæœ¬
  new Vue({
    template: '<div>{{ hi }}</div>'
  })

  // è¿™ç§æƒ…å†µä¸éœ€è¦
  new Vue({
    render (h) {
      return h('div', this.hi)
    }
  })
  ```
- Vue2.0ä¸­ï¼Œæœ€ç»ˆæ¸²æŸ“éƒ½æ˜¯é€šè¿‡`render`å‡½æ•°ï¼Œè‹¥å†™ template å±æ€§ï¼Œæœ€ç»ˆéœ€ç¼–è¯‘æˆ renderï¼Œé‚£ä¹ˆè¿™ä¸ªç¼–è¯‘è¿‡ç¨‹å‘ç”Ÿè¿è¡Œæ—¶ï¼Œéœ€è¦å¸¦æœ‰ç¼–è¯‘å™¨çš„ç‰ˆæœ¬ã€‚æ‰€ä»¥æ›´æ¨è`Runtime Only`

## æ ¹æ®æ‰§è¡Œè¿‡ç¨‹åˆ†ææºç 

å…±ä¹æ­¥ã€‚

### 1. é¦–å…ˆç¼–å†™çš„æ˜¯`.vue`æ–‡ä»¶

### 2. ç”¨ sfc å°† `.vue` => `JS`

- [AST Explorer](https://astexplorer.net/),æºç å’Œè¿™ä¸ªè¯­æ³•ä¸€è‡´ã€‚
- packages/compiler-sfc/srcä¸­, `compileScriptã€compileTemplateã€compileStyle`æ–¹æ³•è§£æ

### 3. `compiler`ç”¨äºç¼–è¯‘å¤„ç†

å…¨æ–‡æœç´¢ğŸ°

### 4. å¯åŠ¨é¡¹ç›®ï¼Œåˆå§‹åŒ–åº”ç”¨ï¼Œnew Vue()

ï¼ˆä¸‹é¢éœ€è¡¥å……ï¼‰


4. å¯åŠ¨é¡¹ç›®ï¼Œåˆå§‹åŒ–åº”ç”¨ï¼Œnew Vue() 
   - core/index.ts => core/global-api:`initGlobalAPI`:
      - initUse(Vue) - åˆå§‹åŒ–æ’ä»¶æœºåˆ¶ - Vue.use(xxx)
      - initMixin(Vue) - Vue.mixin
      - initExtend(Vue) - ç»§æ‰¿æœºåˆ¶ - Vue.extend
      - initAssetRegisters(Vue) - vue2ä¸­ï¼Œsrc/shared/constens.tså°†èµ„æº(ASSET_TYPES)è§„å®šä¸ºä¸‰ç±»ï¼ˆcomponentã€directiveã€filterï¼‰ï¼Œè¿™é‡Œåˆå§‹åŒ–æ˜¯é’ˆå¯¹è¿™ä¸ª
5. å¤„ç†åˆå§‹åŒ–é€»è¾‘ï¼ŒåŒ…å«ç”Ÿå‘½å‘¨æœŸã€Mixinç­‰å†…å®¹
   - core/instance/index.ts
6. åˆ›å»ºå¯¹åº”çš„`vdom`,æŒ‚è½½
   - core/instance/render.ts æŒ‚è½½ => `creatElement` => core/vdom/create-elemnent.ts - åˆå§‹åŒ–åˆ›å»ºçš„é€»è¾‘
7. ä¸€æ—¦å‘ç”Ÿæ›´æ–°,å³dataæ•°æ®å˜æ›´ï¼Œé€šè¿‡ç›‘å¬è§¦å‘
   - Vue2æºç çœ‹è€çš„ç‰ˆæœ¬ï¼Œæ–°ç‰ˆæœ¬å¤§éƒ¨åˆ†æ˜¯Proxyé‡æ„ï¼›çœ‹è¿™[ä¸»è¦é€»è¾‘](https://github.com/vuejs/vue/blob/1.1/src/observer/array.js)
   - [patché€»è¾‘](https://github.com/vuejs/vue/blob/main/src/core/vdom/patch.ts) - diffç®—æ³•å¤„ç†æ—¶ï¼šğŸš©
     ```js
     //ğŸš©é¢è¯•å¸¸é—®ï¼šVueä¸­ :key çš„ä½œç”¨:score/vdom/patch.tsçš„ç¬¬36è¡Œ,å°¤é›¨æºªå®šä¹‰äº†ä¸€ä¸ªsameVnodeæ–¹æ³•ï¼Œ
     //æ ¹èŠ‚ç‚¹åˆç­›ï¼ŒsameVnode å¯¹keyï¼Œtagï¼Œtypeç­‰è¿›è¡Œç®€å•çš„åˆ¤æ–­ï¼Œé€šè¿‡äº†å°±è¿›è¡Œå…·ä½“å·®å¼‚å¯¹æ¯”, ä¸é€šè¿‡å°±æ–°å»ºdomã€‚
     /*ä½œç”¨æ€»ç»“ï¼šVueå“åº”å¼ç³»ç»Ÿä¸­ï¼Œå¤§é‡æºç åšæ€§èƒ½ä¼˜åŒ–çš„äº‹æƒ…ï¼Œå…¶ä¸­å°±åŒ…å«:keyï¼Œåœ¨diffè¿‡ç¨‹ä¸­ï¼Œå§‹ç»ˆä»¥æœ€ä»¥æœ€å°ä»£ä»·ã€
       æœ€å¤§ç¨‹åº¦å»è¿›è¡ŒèŠ‚ç‚¹å¤ç”¨ï¼ˆpatchï¼‰ï¼Œ
       è€Œkeyå°±ä½œä¸ºæˆ‘ä»¬åˆ¤æ–­èŠ‚ç‚¹æ˜¯å¦å¯ä»¥å¤ç”¨çš„ä¸€å¤§æ ‡å‡†ï¼ˆé™¤äº†åˆ¤æ–­keyç›¸åŒ è¿˜æœ‰å…¶ä»–åˆ¤æ–­å¦‚ğŸ’›ï¼‰ã€‚
     */
     function sameVnode(a, b) {
      return (
        a.key === b.key && //keyå…¨ç­‰ è¿™ä¹Ÿæ˜¯ä¸èƒ½ç”¨indexä½œä¸ºkeyçš„åŸå› ğŸš©
        a.asyncFactory === b.asyncFactory &&
        ((a.tag === b.tag &&//ğŸ’›
          a.isComment === b.isComment &&//ğŸ’›
          isDef(a.data) === isDef(b.data) && //ğŸ’›
          //dataä¿å­˜äº†å…ƒç´ ä¸Šçš„å±æ€§ å¦‚attrs: { class: 'box' }, staticStyle: { color: 'red'}ç­‰
          //isDefä½œç”¨ï¼š åˆ¤æ–­å€¼æ˜¯å¦è¢«å®šä¹‰
          sameInputType(a, b)) || //input typeå±æ€§æ˜¯å¦ç›¸åŒ
          (isTrue(a.isAsyncPlaceholder) && isUndef(b.asyncFactory.error)))
      )
     ```
8. æ”¶é›†ä¾èµ–
9. å¤„ç†æ›´æ–°diff

## Vue2 DiffåŸç†

:::info
**diffç›®çš„**ï¼šå°½å¯èƒ½å‡å°‘ dom å˜æ›´å¼•èµ·çš„ reflow å’Œ repaintï¼Œæ‰¾åˆ°å¯ä»¥å¤ç”¨çš„èŠ‚ç‚¹ã€‚

**åŒç«¯diff**ï¼šæ–°æ—§åˆ—è¡¨çš„å¤´ä¸å°¾äº’ç›¸å¯¹æ¯”ï¼Œåœ¨å¯¹æ¯”è¿‡ç¨‹ä¸­æŒ‡é’ˆä¼šé€æ¸å‘å†…é æ‹¢ï¼Œç›´åˆ°æŸä¸€ä¸ªåˆ—è¡¨çš„èŠ‚ç‚¹å…¨éƒ¨éå†è¿‡ï¼Œå¯¹æ¯”åœæ­¢ã€‚ï¼ˆæ ¸å¿ƒupdateChildrenâ­ï¼‰

**ç¼ºç‚¹**ï¼šVue2 Diffæ˜¯å…¨é‡Diffï¼ˆå½“æ•°æ®å‘ç”Ÿå˜åŒ–ï¼Œå°±ä¼šäº§ç”Ÿ DOM æ ‘ï¼Œå¹¶å’Œä¹‹å‰çš„ DOM æ ‘æ¯”è¾ƒæ‰¾åˆ°ä¸åŒèŠ‚ç‚¹æ›´æ–°ï¼‰ã€‚è‹¥å±‚çº§å¾ˆé«˜ï¼Œéå¸¸æ¶ˆè€—å†…å­˜ã€‚
:::
ä»¥ä¸‹æ˜¯å…·ä½“åˆ†æï¼š
### 1.patch

å…ˆåˆ¤æ–­æ˜¯å¦é¦–æ¬¡æ¸²æŸ“ï¼Œé¦–æ¬¡ç›´æ¥ creatElmï¼›è‹¥ä¸æ˜¯å°±åˆ¤æ–­æ–°è€ä¸¤ä¸ªèŠ‚ç‚¹çš„å…ƒç´ ç±»å‹æ˜¯å¦ä¸€æ ·ï¼›å¦‚æœä¸¤ä¸ªèŠ‚ç‚¹éƒ½ä¸€æ ·ï¼Œå°±æ·±å…¥æ£€æŸ¥å¯¹åº”çš„å­èŠ‚ç‚¹ã€‚è‹¥ä¸¤ä¸ªèŠ‚ç‚¹ä¸ä¸€æ ·åˆ™è¯´æ˜ Vnode å®Œå…¨è¢«æ”¹å˜äº†ï¼Œç›´æ¥æ›¿æ¢ oldVnode å³å¯ã€‚

```ts
function patch(oldVnode, vnode, hydrating, removeOnly) {
  // åˆ¤æ–­æ–°çš„vnodeæ˜¯å¦ä¸ºç©º
  if (isUndef(vnode)) {//æ–°vnodeä¸ºç©º
    // å¦‚æœè€çš„vnodeä¸ä¸ºç©º å¸è½½æ‰€æœ‰çš„è€vnode
    if (isDef(oldVnode)) invokeDestroyHook(oldVnode)
    return
  }
  let isInitialPatch = false
  // ç”¨æ¥å­˜å‚¨ inserté’©å­å‡½æ•°ï¼Œåœ¨æ’å…¥èŠ‚ç‚¹ä¹‹å‰è°ƒç”¨
  const insertedVnodeQueue = []
  // å¦‚æœè€èŠ‚ç‚¹ä¸å­˜åœ¨ï¼Œç›´æ¥åˆ›å»ºæ–°èŠ‚ç‚¹
  if (isUndef(oldVnode)) {
    isInitialPatch = true
    createElm(vnode, insertedVnodeQueue)
  } else {
    // æ˜¯ä¸æ˜¯å…ƒç´ èŠ‚ç‚¹
    const isRealElement = isDef(oldVnode.nodeType)
    // å½“è€èŠ‚ç‚¹ä¸æ˜¯çœŸå®çš„DOMèŠ‚ç‚¹ï¼Œå¹¶ä¸”æ–°è€èŠ‚ç‚¹çš„typeå’Œkeyç›¸åŒï¼Œè¿›è¡ŒpatchVnodeæ›´æ–°å·¥ä½œ
    if (!isRealElement && sameVnode(oldVnode, vnode)) {
      patchVnode(oldVnode, vnode, insertedVnodeQueue, null, null, removeOnly)
    } else {
      // å¦‚æœä¸æ˜¯åŒä¸€å…ƒç´ èŠ‚ç‚¹çš„è¯
      // å½“è€èŠ‚ç‚¹æ˜¯çœŸå®DOMèŠ‚ç‚¹çš„æ—¶å€™
      if (isRealElement) {
        // å¦‚æœæ˜¯å…ƒç´ èŠ‚ç‚¹ å¹¶ä¸”åœ¨SSRç¯å¢ƒçš„æ—¶å€™ ä¿®æ”¹SSR_ATTRå±æ€§
        if (oldVnode.nodeType === 1 && oldVnode.hasAttribute(SSR_ATTR)) {
          // å°±æ˜¯æœåŠ¡ç«¯æ¸²æŸ“çš„ï¼Œåˆ æ‰è¿™ä¸ªå±æ€§
          oldVnode.removeAttribute(SSR_ATTR)
          hydrating = true
        }
        // è¿™ä¸ªåˆ¤æ–­é‡Œæ˜¯æœåŠ¡ç«¯æ¸²æŸ“çš„å¤„ç†é€»è¾‘
        if (isTrue(hydrating)) {
          if (hydrate(oldVnode, vnode, insertedVnodeQueue)) {
            invokeInsertHook(vnode, insertedVnodeQueue, true)
            return oldVnode
          }
        }
        // å¦‚æœä¸æ˜¯æœåŠ¡ç«¯æ¸²æŸ“çš„ï¼Œæˆ–è€…æ··åˆå¤±è´¥ï¼Œå°±åˆ›å»ºä¸€ä¸ªç©ºçš„æ³¨é‡ŠèŠ‚ç‚¹æ›¿æ¢ oldVnode
        oldVnode = emptyNodeAt(oldVnode)
      }

      // æ‹¿åˆ° oldVnode çš„çˆ¶èŠ‚ç‚¹
      const oldElm = oldVnode.elm
      const parentElm = nodeOps.parentNode(oldElm)

      // æ ¹æ®æ–°çš„ vnode åˆ›å»ºä¸€ä¸ª DOM èŠ‚ç‚¹ï¼ŒæŒ‚è½½åˆ°çˆ¶èŠ‚ç‚¹ä¸Š
      createElm(
        vnode,
        insertedVnodeQueue,
        oldElm._leaveCb ? null : parentElm,
        nodeOps.nextSibling(oldElm)
      )
      // å¦‚æœæ–°çš„ vnode çš„æ ¹èŠ‚ç‚¹å­˜åœ¨ï¼Œå°±æ˜¯è¯´æ ¹èŠ‚ç‚¹è¢«ä¿®æ”¹äº†ï¼Œå°±éœ€è¦éå†æ›´æ–°çˆ¶èŠ‚ç‚¹
      // é€’å½’ æ›´æ–°çˆ¶å ä½ç¬¦å…ƒç´ 
      // å°±æ˜¯æ‰§è¡Œä¸€é çˆ¶èŠ‚ç‚¹çš„ destory å’Œ create ã€insert çš„ é’©å­å‡½æ•°
      if (isDef(vnode.parent)) {
        let ancestor = vnode.parent
        const patchable = isPatchable(vnode)
        // æ›´æ–°çˆ¶ç»„ä»¶çš„å ä½å…ƒç´ 
        while (ancestor) {
          // å¸è½½è€æ ¹èŠ‚ç‚¹ä¸‹çš„å…¨éƒ¨ç»„ä»¶
          for (let i = 0; i < cbs.destroy.length; ++i) {
            cbs.destroy[i](ancestor)
          }
          // æ›¿æ¢ç°æœ‰å…ƒç´ 
          ancestor.elm = vnode.elm
          if (patchable) {
            for (let i = 0; i < cbs.create.length; ++i) {
              cbs.create[i](emptyNode, ancestor)
            }
            // #6513
            // invoke insert hooks that may have been merged by create hooks.
            // e.g. for directives that uses the "inserted" hook.
            const insert = ancestor.data.hook.insert
            if (insert.merged) {
              // start at index 1 to avoid re-invoking component mounted hook
              for (let i = 1; i < insert.fns.length; i++) {
                insert.fns[i]()
              }
            }
          } else {
            registerRef(ancestor)
          }
          // æ›´æ–°çˆ¶èŠ‚ç‚¹
          ancestor = ancestor.parent
        }
      }
      // å¦‚æœæ—§èŠ‚ç‚¹è¿˜å­˜åœ¨ï¼Œå°±åˆ æ‰æ—§èŠ‚ç‚¹
      if (isDef(parentElm)) {
        removeVnodes([oldVnode], 0, 0)
      } else if (isDef(oldVnode.tag)) {
        // å¦åˆ™ç›´æ¥å¸è½½ oldVnode
        invokeDestroyHook(oldVnode)
      }
    }
  }
  // æ‰§è¡Œ è™šæ‹Ÿ dom çš„ insert é’©å­å‡½æ•°
  invokeInsertHook(vnode, insertedVnodeQueue, isInitialPatch)
  // è¿”å›æœ€æ–° vnode çš„ elm ï¼Œä¹Ÿå°±æ˜¯çœŸå®çš„ domèŠ‚ç‚¹
  return vnode.elm
}
```

### 2.patchNode

- è‹¥`Vnode`å’Œ`oldVnode`æŒ‡å‘åŒä¸€ä¸ªå¯¹è±¡ï¼Œç›´æ¥returnï¼›
- å°†æ—§èŠ‚ç‚¹çš„çœŸå® DOM èµ‹å€¼åˆ°æ–°èŠ‚ç‚¹ï¼ˆçœŸå®domè¿çº¿åˆ°æ–°å­èŠ‚ç‚¹ï¼‰ç§°ä¸º elmï¼Œç„¶åéå†è°ƒç”¨ update æ›´æ–°`oldVnode`ä¸Šçš„æ‰€æœ‰å±æ€§ï¼Œå¦‚classã€styleã€attrsã€domPropsã€events...
- è‹¥æ–°è€èŠ‚ç‚¹éƒ½æœ‰æ–‡æœ¬èŠ‚ç‚¹ï¼Œä¸”æ–‡æœ¬ä¸ç›¸åŒï¼Œå°±ç”¨`vnode.text`æ›´æ–°æ–‡æœ¬å†…å®¹ï¼›
- è‹¥ oldVnode æœ‰å­èŠ‚ç‚¹è€Œ `Vnode`æ²¡æœ‰ï¼Œç›´æ¥åˆ é™¤è€èŠ‚ç‚¹ï¼›
- è‹¥ oldVnode æ²¡æœ‰å­èŠ‚ç‚¹è€Œ `Vnode`æœ‰ï¼Œå°† Vnode çš„å­èŠ‚ç‚¹çœŸå®åŒ–åæ·»åŠ åˆ° DOM ä¸­å³å¯ï¼›
- è‹¥ä¸¤è€…éƒ½æœ‰å­èŠ‚ç‚¹ï¼Œæ‰§è¡Œ`updateChildren`æ¯”è¾ƒå­èŠ‚ç‚¹ã€‚

```ts
function patchVnode(
  oldVnode, // è€çš„è™šæ‹Ÿ DOM èŠ‚ç‚¹
  vnode, // æ–°èŠ‚ç‚¹
  insertedVnodeQueue, // æ’å…¥èŠ‚ç‚¹é˜Ÿåˆ—
  ownerArray, // èŠ‚ç‚¹æ•°ç»„
  index, // å½“å‰èŠ‚ç‚¹çš„ä¸‹æ ‡
  removeOnly
) {
  // æ–°è€èŠ‚ç‚¹å¯¹æ¯”åœ°å€ä¸€æ ·ï¼Œç›´æ¥è·³è¿‡
  if (oldVnode === vnode) {
    return
  }
  if (isDef(vnode.elm) && isDef(ownerArray)) {
    // clone reused vnode
    vnode = ownerArray[index] = cloneVNode(vnode)
  }
  const elm = vnode.elm = oldVnode.elm
  // å¦‚æœå½“å‰èŠ‚ç‚¹æ˜¯æ³¨é‡Šæˆ– v-if çš„ï¼Œæˆ–è€…æ˜¯å¼‚æ­¥å‡½æ•°ï¼Œå°±è·³è¿‡æ£€æŸ¥å¼‚æ­¥ç»„ä»¶
  if (isTrue(oldVnode.isAsyncPlaceholder)) {
    if (isDef(vnode.asyncFactory.resolved)) {
      hydrate(oldVnode.elm, vnode, insertedVnodeQueue)
    } else {
      vnode.isAsyncPlaceholder = true
    }
    return
  }
  // å½“å‰èŠ‚ç‚¹æ˜¯é™æ€èŠ‚ç‚¹çš„æ—¶å€™ï¼Œkey ä¹Ÿä¸€æ ·ï¼Œæˆ–è€…æœ‰ v-once çš„æ—¶å€™ï¼Œå°±ç›´æ¥èµ‹å€¼è¿”å›
  if (isTrue(vnode.isStatic) &&
    isTrue(oldVnode.isStatic) &&
    vnode.key === oldVnode.key &&
    (isTrue(vnode.isCloned) || isTrue(vnode.isOnce))
  ) {
    vnode.componentInstance = oldVnode.componentInstance
    return
  }
  let i
  const data = vnode.data
  if (isDef(data) && isDef(i = data.hook) && isDef(i = i.prepatch)) {
    i(oldVnode, vnode)
  }
  const oldCh = oldVnode.children
  const ch = vnode.children
  if (isDef(data) && isPatchable(vnode)) {
    // éå†è°ƒç”¨ update æ›´æ–° oldVnode æ‰€æœ‰å±æ€§ï¼Œæ¯”å¦‚ class,style,attrs,domProps,events...
    // è¿™é‡Œçš„ update é’©å­å‡½æ•°æ˜¯ vnode æœ¬èº«çš„é’©å­å‡½æ•°
    for (i = 0; i < cbs.update.length; ++i) cbs.update[i](oldVnode, vnode)
    // è¿™é‡Œçš„ update é’©å­å‡½æ•°æ˜¯æˆ‘ä»¬ä¼ è¿‡æ¥çš„å‡½æ•°
    if (isDef(i = data.hook) && isDef(i = i.update)) i(oldVnode, vnode)
  }
  // å¦‚æœæ–°èŠ‚ç‚¹ä¸æ˜¯æ–‡æœ¬èŠ‚ç‚¹ï¼Œä¹Ÿå°±æ˜¯è¯´æœ‰å­èŠ‚ç‚¹
  if (isUndef(vnode.text)) {
    // å¦‚æœæ–°è€èŠ‚ç‚¹éƒ½æœ‰å­èŠ‚ç‚¹
    if (isDef(oldCh) && isDef(ch)) {
      // å¦‚æœæ–°è€èŠ‚ç‚¹çš„å­èŠ‚ç‚¹ä¸ä¸€æ ·ï¼Œå°±æ‰§è¡Œ updateChildren å‡½æ•°ï¼Œå¯¹æ¯”å­èŠ‚ç‚¹
      if (oldCh !== ch) updateChildren(elm, oldCh, ch, insertedVnodeQueue, removeOnly)
    } else if (isDef(ch)) {
      // å¦‚æœæ–°èŠ‚ç‚¹æœ‰å­èŠ‚ç‚¹çš„è¯ï¼Œå°±æ˜¯è¯´è€èŠ‚ç‚¹æ²¡æœ‰å­èŠ‚ç‚¹

      // å¦‚æœè€èŠ‚ç‚¹æ˜¯æ–‡æœ¬èŠ‚ç‚¹ï¼Œå°±æ˜¯è¯´æ²¡æœ‰å­èŠ‚ç‚¹ï¼Œå°±æ¸…ç©º
      if (isDef(oldVnode.text)) nodeOps.setTextContent(elm, '')
      // æ·»åŠ æ–°èŠ‚ç‚¹
      addVnodes(elm, null, ch, 0, ch.length - 1, insertedVnodeQueue)
    } else if (isDef(oldCh)) {
      // å¦‚æœæ–°èŠ‚ç‚¹æ²¡æœ‰å­èŠ‚ç‚¹ï¼Œè€èŠ‚ç‚¹æœ‰å­èŠ‚ç‚¹ï¼Œå°±åˆ é™¤
      removeVnodes(oldCh, 0, oldCh.length - 1)
    } else if (isDef(oldVnode.text)) {
      // å¦‚æœè€èŠ‚ç‚¹æ˜¯æ–‡æœ¬èŠ‚ç‚¹ï¼Œå°±æ¸…ç©º
      nodeOps.setTextContent(elm, '')
    }
  } else if (oldVnode.text !== vnode.text) {
    // å¦‚æœè€èŠ‚ç‚¹çš„æ–‡æœ¬å’Œæ–°èŠ‚ç‚¹çš„æ–‡æœ¬ä¸åŒï¼Œå°±æ›´æ–°æ–‡æœ¬
    nodeOps.setTextContent(elm, vnode.text)
  }
  if (isDef(data)) {
    if (isDef(i = data.hook) && isDef(i = i.postpatch)) i(oldVnode, vnode)
  }
}
```


### 3.updateChildren

æ³¨æ„ï¼Œè¿™æ˜¯é’ˆå¯¹æ–°æ—§è™šæ‹ŸèŠ‚ç‚¹éƒ½æœ‰å­èŠ‚ç‚¹æ—¶ï¼Œæ¯”è¾ƒå­èŠ‚ç‚¹å·®å¼‚çš„å‡½æ•°ã€‚ä»¥ä¸‹æ˜¯æ‰‹åŠ¨å®ç° Vue2 ä¸­çš„ updateChildren è¿‡ç¨‹ã€‚

#### 3.1 å®ç°æ€è·¯

1ï¸âƒ£å…ˆç”¨ 4 ä¸ªæŒ‡é’ˆæŒ‡å‘ä¸¤ä¸ªåˆ—è¡¨çš„å¤´å°¾ï¼š
```ts
function vue2Diff(prevChildren, nextChildren, parent) {
  let oldStartIndex = 0,
    oldEndIndex = prevChildren.length - 1
    newStartIndex = 0,
    newEndIndex = nextChildren.length - 1;
  let oldStartNode = prevChildren[oldStartIndex],
    oldEndNode = prevChildren[oldEndIndex],
    newStartNode = nextChildren[nextStartIndex],
    newEndNode = nextChildren[nextEndIndex];
}
```
2ï¸âƒ£æ ¹æ® 4 ä¸ªæŒ‡é’ˆæ‰¾åˆ° 4 ä¸ªèŠ‚ç‚¹ï¼Œç„¶åè¿›è¡Œå¯¹æ¯”ï¼Œä»¥ä¸‹æ˜¯å¯¹æ¯”çš„æ­¥éª¤ï¼š

    ğŸ¦æ¯”è¾ƒé¡ºåºå£è¯€ï¼šé¦–é¦–æ¯”è¾ƒã€å°¾å°¾æ¯”è¾ƒã€å°¾é¦–æ¯”è¾ƒã€é¦–å°¾æ¯”è¾ƒ

  1. ä½¿ç”¨æ—§åˆ—è¡¨çš„å¤´ä¸€ä¸ªèŠ‚ç‚¹`oldStartNode`ä¸æ–°åˆ—è¡¨çš„å¤´ä¸€ä¸ªèŠ‚ç‚¹`newStartNode`å¯¹æ¯”
  2. ä½¿ç”¨æ—§åˆ—è¡¨çš„æœ€åä¸€ä¸ªèŠ‚ç‚¹`oldEndtNode`ä¸æ–°åˆ—è¡¨çš„æœ€åä¸€ä¸ªèŠ‚ç‚¹`newEndNode`å¯¹æ¯”
  3. ä½¿ç”¨æ–°åˆ—è¡¨çš„æœ€åä¸€ä¸ªèŠ‚ç‚¹`newEndNode`ä¸æ—§åˆ—è¡¨çš„å¤´ä¸€ä¸ªèŠ‚ç‚¹`oldStartNode`å¯¹æ¯”
  4. ä½¿ç”¨æ–°åˆ—è¡¨çš„å¤´ä¸€ä¸ªèŠ‚ç‚¹`newStartNode`ä¸æ—§åˆ—è¡¨çš„æœ€åä¸€ä¸ªèŠ‚ç‚¹`oldEndtNode`å¯¹æ¯”

3ï¸âƒ£ä½¿ç”¨ä»¥ä¸Šå››æ­¥å¯¹æ¯”ï¼Œå»å¯»æ‰¾ key ç›¸åŒçš„å¯å¤ç”¨èŠ‚ç‚¹ï¼Œå½“åœ¨æŸä¸€æ­¥æ‰¾åˆ°äº†å°±åœæ­¢åé¢çš„å¯»æ‰¾ï¼Œå¦‚ä¸‹å›¾:

  <img src="https://cetacea-1304984885.cos.ap-shanghai.myqcloud.com/pieces/Snipaste_2024-04-11_20-05-58.jpg">
  å¯¹æ¯”é¡ºåºä»£ç å¦‚ä¸‹ï¼š

  ```ts
  function vue2Diff(prevChildren, nextChildren, parent) {
    let oldStartIndex = 0,
      oldEndIndex = prevChildren.length - 1
      newStartIndex = 0,
      newEndIndex = nextChildren.length - 1;
    let oldStartNode = prevChildren[oldStartIndex],
      oldEndNode = prevChildren[oldEndIndex],
      newStartNode = nextChildren[newStartIndex],
      newEndNode = nextChildren[newEndIndex];
    
    if (oldStartNode.key === newStartNode.key) {
    } else if (oldEndNode.key === newEndNode.key) {
    } else if (oldStartNode.key === newEndNode.key) {
    } else if (oldEndNode.key === newStartNode.key) {
    }
  }
  ```
4ï¸âƒ£å½“å¯¹æ¯”æ—¶æ‰¾åˆ°äº†å¯å¤ç”¨çš„èŠ‚ç‚¹ï¼Œæˆ‘ä»¬è¿˜æ˜¯å…ˆpatchç»™å…ƒç´ æ‰“è¡¥ä¸ï¼Œç„¶åå°†æŒ‡é’ˆè¿›è¡Œå‰/åç§»ä¸€ä½æŒ‡é’ˆã€‚æ ¹æ®å¯¹æ¯”èŠ‚ç‚¹çš„ä¸åŒï¼Œæˆ‘ä»¬ç§»åŠ¨çš„æŒ‡é’ˆå’Œæ–¹å‘ä¹Ÿä¸åŒï¼Œå…·ä½“è§„åˆ™å¦‚ä¸‹ï¼š
  1. å½“æ—§åˆ—è¡¨çš„å¤´ä¸€ä¸ªèŠ‚ç‚¹`oldStartNode`ä¸æ–°åˆ—è¡¨çš„å¤´ä¸€ä¸ªèŠ‚ç‚¹`newStartNode`å¯¹æ¯”æ—¶keyç›¸åŒã€‚é‚£ä¹ˆæ—§åˆ—è¡¨çš„å¤´æŒ‡é’ˆ`oldStartIndex`ä¸æ–°åˆ—è¡¨çš„å¤´æŒ‡é’ˆ`newStartIndex`åŒæ—¶å‘åç§»åŠ¨ä¸€ä½ï¼›
  2. å½“æ—§åˆ—è¡¨çš„æœ€åä¸€ä¸ªèŠ‚ç‚¹`oldEndNode`ä¸æ–°åˆ—è¡¨çš„æœ€åä¸€ä¸ªèŠ‚ç‚¹`newEndNode`å¯¹æ¯”æ—¶keyç›¸åŒã€‚é‚£ä¹ˆæ—§åˆ—è¡¨çš„å°¾æŒ‡é’ˆ`oldEndIndex`ä¸æ–°åˆ—è¡¨çš„å°¾æŒ‡é’ˆ`newEndIndex`åŒæ—¶å‘å‰ç§»åŠ¨ä¸€ä½ï¼›
  3. å½“æ—§åˆ—è¡¨çš„å¤´ä¸€ä¸ªèŠ‚ç‚¹`oldStartNode`ä¸æ–°åˆ—è¡¨çš„æœ€åä¸€ä¸ªèŠ‚ç‚¹`newEndNode`å¯¹æ¯”æ—¶keyç›¸åŒã€‚é‚£ä¹ˆæ—§åˆ—è¡¨çš„å¤´æŒ‡é’ˆ`oldStartIndex`å‘åç§»åŠ¨ä¸€ä½ï¼›æ–°åˆ—è¡¨çš„å°¾æŒ‡é’ˆ`newEndIndex`å‘å‰ç§»åŠ¨ä¸€ä½ï¼›
  4. å½“æ—§åˆ—è¡¨çš„æœ€åä¸€ä¸ªèŠ‚ç‚¹`oldEndNode`ä¸æ–°åˆ—è¡¨çš„å¤´ä¸€ä¸ªèŠ‚ç‚¹`newStartNode`å¯¹æ¯”æ—¶keyç›¸åŒã€‚é‚£ä¹ˆæ—§åˆ—è¡¨çš„å°¾æŒ‡é’ˆ`oldEndIndex`å‘å‰ç§»åŠ¨ä¸€ä½ï¼›æ–°åˆ—è¡¨çš„å¤´æŒ‡é’ˆ`newStartIndex`å‘åç§»åŠ¨ä¸€ä½ï¼›

    ğŸ¦tips:æŒ‡é’ˆé€æ¸å‘å†…é æ‹¢ï¼Œåœ¨æ•°å­¦ä¸­å±äºå‡½æ•°çš„å‘æ•£ä¸æ”¶æ•›çš„æ”¶æ•›æ€§ã€‚

5ï¸âƒ£ä¸Šé¢æåˆ°ï¼Œè¦è®©æŒ‡é’ˆå‘å†…é æ‹¢ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦å¾ªç¯ã€‚å¾ªç¯åœæ­¢çš„æ¡ä»¶æ˜¯å½“å…¶ä¸­ä¸€ä¸ªåˆ—è¡¨çš„èŠ‚ç‚¹å…¨éƒ¨éå†å®Œæˆï¼Œä»£ç å¦‚ä¸‹ï¼š
  ```ts
  function vue2Diff(prevChildren, nextChildren, parent) {
    let oldStartIndex = 0,
      oldEndIndex = prevChildren.length - 1,
      newStartIndex = 0,
      newEndIndex = nextChildren.length - 1;
    let oldStartNode = prevChildren[oldStartIndex],
      oldEndNode = prevChildren[oldEndIndex],
      newStartNode = nextChildren[newStartIndex],
      newEndNode = nextChildren[newEndIndex];
    while (oldStartIndex <= oldEndIndex && newStartIndex <= newEndIndex) {
      if (oldStartNode.key === newStartNode.key) {
        patch(oldStartNode, newStartNode, parent)

        oldStartIndex++
        newStartIndex++
        oldStartNode = prevChildren[oldStartIndex]
        newStartNode = nextChildren[newStartIndex]
      } else if (oldEndNode.key === newEndNode.key) {
        patch(oldEndNode, newEndNode, parent)

        oldEndIndex--
        newndIndex--
        oldEndNode = prevChildren[oldEndIndex]
        newEndNode = nextChildren[newEndIndex]
      } else if (oldStartNode.key === newEndNode.key) {
        patch(oldvStartNode, newEndNode, parent)

        oldStartIndex++
        newEndIndex--
        oldStartNode = prevChildren[oldStartIndex]
        newEndNode = nextChildren[newEndIndex]
      } else if (oldEndNode.key === newStartNode.key) {
        patch(oldEndNode, newStartNode, parent)

        oldEndIndex--
        newStartIndex++
        oldEndNode = prevChildren[oldEndIndex]
        newStartNode = nextChildren[newStartIndex]
      }
    }   
  }
  ```
6ï¸âƒ£è‡³æ­¤æ•´ä½“çš„å¾ªç¯æˆ‘ä»¬å°±å…¨éƒ¨å®Œæˆäº†ï¼Œä¸‹é¢æˆ‘ä»¬éœ€è¦è€ƒè™‘è¿™æ ·ä¸¤ä¸ªé—®é¢˜ï¼š
  - ä»€ä¹ˆæƒ…å†µä¸‹DOMèŠ‚ç‚¹éœ€è¦ç§»åŠ¨ï¼›
  - DOMèŠ‚ç‚¹å¦‚ä½•ç§»åŠ¨(è§ç›®å½•3.3å’Œ3.4)

  **ğŸ”´é¦–å…ˆçœ‹ç¬¬ä¸€ä¸ªé—®é¢˜:**

  ğŸ”´**ç¬¬ä¸€ä¸ªå¾ªç¯ç»“æŸå:**
  <img src="https://cetacea-1304984885.cos.ap-shanghai.myqcloud.com/pieces/Snipaste_2024-04-11_20-05-58.jpg">

  åœ¨ç¬¬å››æ­¥å‘ç°æ—§åˆ—è¡¨çš„å°¾èŠ‚ç‚¹`oldEndNode`ä¸æ–°åˆ—è¡¨çš„å¤´èŠ‚ç‚¹`newStartNode`çš„keyç›¸åŒ(dèŠ‚ç‚¹)ï¼Œæ˜¯å¯å¤ç”¨çš„DOMèŠ‚ç‚¹ã€‚é€šè¿‡è§‚å¯Ÿï¼ŒåŸæœ¬åœ¨æ—§åˆ—è¡¨æœ«å°¾çš„èŠ‚ç‚¹ï¼Œæ˜¯æ–°åˆ—è¡¨å¼€å¤´çš„èŠ‚ç‚¹ï¼Œæ²¡æœ‰èŠ‚ç‚¹æ¯”ä»–æ›´é å‰ã€‚å› ä¸ºä»–æ˜¯ç¬¬ä¸€ä¸ªï¼Œæ‰€ä»¥åªéœ€æŠŠå½“å‰çš„èŠ‚ç‚¹ç§»åŠ¨åˆ°æ—§åˆ—è¡¨çš„ç¬¬ä¸€ä¸ªèŠ‚ç‚¹ä¹‹å‰ï¼Œè®©ã€€DOM-Dã€€æˆä¸ºç¬¬ä¸€ä¸ªèŠ‚ç‚¹å³å¯ã€‚
  ```ts
  function vue2Diff(prevChildren, nextChildren, parent) {
    while (oldStartIndex <= oldEndIndex && newStartIndex <= newEndIndex) {
      if (oldStartNode.key === newStartNode.key) {
        // ...
      } else if (oldEndNode.key === newEndNode.key) {
        // ...
      } else if (oldStartNode.key === newEndNode.key) {
        // ...
      } else if (oldEndNode.key === newStartNode.key) {
        patch(oldEndNode, newStartNode, parent)
        // ç§»åŠ¨åˆ°æ—§åˆ—è¡¨å¤´èŠ‚ç‚¹ä¹‹å‰
        parent.insertBefore(oldEndNode.el, oldStartNode.el)
        
        oldEndIndex--
        newStartIndex++
        oldEndNode = prevChildren[oldEndIndex]
        newStartNode = nextChildren[newStartIndex]
      }
    }
  }
  ```

  ğŸ”´**è¿›å…¥ç¬¬äºŒæ¬¡å¾ªç¯ï¼š**
  <img src="https://cetacea-1304984885.cos.ap-shanghai.myqcloud.com/pieces/Snipaste_2024-04-12_10-13-22.jpg">
  åœ¨ç¬¬äºŒæ­¥å‘ç°ï¼Œ`oldEndNode`å’Œ`newEndNode`æ˜¯å¤ç”¨èŠ‚ç‚¹ï¼ˆå¦‚ä¸Šå›¾cèŠ‚ç‚¹ï¼‰ã€‚åŸæœ¬åœ¨æ—§åˆ—è¡¨ä¸­å°±æ˜¯å°¾éƒ¨ï¼Œåœ¨æ–°åˆ—è¡¨ä¸­ä¹Ÿæ˜¯å°¾éƒ¨ï¼Œè¯´æ˜CèŠ‚ç‚¹ä¸éœ€è¦ç§»åŠ¨ã€‚
  `oldStartNode`å’Œ`newStartNode`åŒç†ã€‚

  ğŸ”´**è¿›å…¥ç¬¬ä¸‰æ¬¡å¾ªç¯ï¼š**
  <img src="https://cetacea-1304984885.cos.ap-shanghai.myqcloud.com/pieces/Snipaste_2024-04-12_16-38-31.jpg">
  åœ¨ç¬¬ä¸‰æ­¥å‘ç°ï¼Œaä¸ºå¤ç”¨èŠ‚ç‚¹ï¼Œå°† DOM-A ç§»åŠ¨åˆ° DOM-B å³å¯ã€‚
  
  ğŸ”´**è¿›å…¥æœ€åä¸€æ¬¡å¾ªç¯ï¼š**
  <img src="https://cetacea-1304984885.cos.ap-shanghai.myqcloud.com/pieces/Snipaste_2024-04-12_16-46-07.jpg">
  åœ¨ç¬¬ä¸€æ­¥æ—§åˆ—è¡¨å¤´èŠ‚ç‚¹`oldStartNode`ä¸æ–°åˆ—è¡¨å¤´èŠ‚ç‚¹`newStartNode`ä½ç½®ç›¸åŒï¼Œæ‰€ä»¥å•¥ä¹Ÿä¸ç”¨åšã€‚ç„¶åç»“æŸå¾ªç¯ã€‚


#### 3.2 éç†æƒ³æƒ…å†µ

1ï¸âƒ£ä¸Šæ–‡å­˜åœ¨å››æ¬¡å¯¹æ¯”éƒ½æ²¡æœ‰æ‰¾åˆ°å¯å¤ç”¨èŠ‚ç‚¹çš„ç‰¹æ®Šæƒ…å†µã€‚è¿™æ—¶éœ€æ‹¿æ–°åˆ—è¡¨çš„ç¬¬ä¸€ä¸ªèŠ‚ç‚¹å»å’Œæ—§åˆ—è¡¨æ¯”å¯¹ï¼Œæ‰¾å‡ºç›¸åŒ keyã€‚

2ï¸âƒ£æ¥ç¬¬1ï¸âƒ£æ­¥ï¼Œæœ‰ä¸¤ç§ç»“æœï¼Œæ‰¾åˆ°keyå’Œæ²¡æ‰¾åˆ°keyã€‚æ‰¾åˆ°äº†ï¼Œä»¬åªéœ€è¦å°†æ‰¾åˆ°çš„èŠ‚ç‚¹çš„DOMå…ƒç´ ï¼Œç§»åŠ¨åˆ°å¼€å¤´ï¼›DOMç§»åŠ¨åï¼Œç”±æˆ‘ä»¬å°†æ—§åˆ—è¡¨ä¸­çš„èŠ‚ç‚¹æ”¹ä¸ºundefinedï¼Œè¿™æ˜¯è‡³å…³é‡è¦çš„ä¸€æ­¥ï¼Œå› ä¸ºæˆ‘ä»¬å·²ç»åšäº†èŠ‚ç‚¹çš„ç§»åŠ¨äº†æ‰€ä»¥æˆ‘ä»¬ä¸éœ€è¦è¿›è¡Œå†æ¬¡çš„å¯¹æ¯”äº†ã€‚æœ€åæˆ‘ä»¬å°†å¤´æŒ‡é’ˆ`newStartIndex`å‘åç§»ä¸€ä½ã€‚

3ï¸âƒ£æ²¡æœ‰æ‰¾åˆ°ï¼Œç›´æ¥åˆ›å»ºä¸€ä¸ªæ–°çš„èŠ‚ç‚¹æ”¾åˆ°æœ€å‰é¢å°±å¯ä»¥äº†ï¼Œç„¶ååç§»å¤´æŒ‡é’ˆ`newStartIndex`ã€‚

4ï¸âƒ£å½“æ—§åˆ—è¡¨éå†åˆ°undefinedå°±è·³è¿‡å½“å‰èŠ‚ç‚¹ã€‚

```ts
function vue2Diff(prevChildren, nextChildren, parent) {
  //4.å½“æ—§åˆ—è¡¨éå†åˆ°undefinedå°±è·³è¿‡å½“å‰èŠ‚ç‚¹
  while (oldStartIndex <= oldEndIndex && newStartIndex <= newEndIndex) {
    if (oldStartNode.key === newStartNode.key) {...}
    else if (oldEndNode.key === newEndNode.key) {...}
    else if (oldStartNode.key === newEndNode.key) {...}
    else if (oldEndNode.key === newStartNode.key) {...}
    else {
      // 1.åœ¨æ—§åˆ—è¡¨ä¸­æ‰¾åˆ° å’Œæ–°åˆ—è¡¨å¤´èŠ‚ç‚¹key ç›¸åŒçš„èŠ‚ç‚¹
      let newtKey = newStartNode.key,
        oldIndex = prevChildren.findIndex(child => child.key === newKey);
      if (oldIndex > -1) {
        //2.æ‰¾åˆ°çš„æƒ…å†µ
        let oldNode = prevChildren[oldIndex];
        patch(oldNode, newStartNode, parent)
        parent.insertBefore(oldNode.el, oldStartNode.el)
        prevChildren[oldIndex] = undefined
      } else {
        //3.æ²¡æœ‰æ‰¾åˆ°çš„æƒ…å†µ
        mount(newStartNode, parent, oldStartNode.el)
      }
      newStartNode = nextChildren[++newStartIndex]
    }
  }
}
```

#### 3.3 æ·»åŠ èŠ‚ç‚¹

å½“`oldEndIndex`å°äº`oldStartIndex`ï¼Œä½†æ˜¯æ–°åˆ—è¡¨ä¸­è¿˜æœ‰å‰©ä½™çš„èŠ‚ç‚¹ï¼Œæˆ‘ä»¬åªéœ€è¦å°†å‰©ä½™çš„èŠ‚ç‚¹ä¾æ¬¡æ’å…¥åˆ°oldStartNodeçš„DOMä¹‹å‰å°±å¯ä»¥äº†ã€‚ä¸ºä»€ä¹ˆæ˜¯æ’å…¥oldStartNodeä¹‹å‰å‘¢ï¼ŸåŸå› æ˜¯å‰©ä½™çš„èŠ‚ç‚¹åœ¨æ–°åˆ—è¡¨çš„ä½ç½®æ˜¯ä½äºoldStartNodeä¹‹å‰çš„ï¼Œå¦‚æœå‰©ä½™èŠ‚ç‚¹æ˜¯åœ¨oldStartNodeä¹‹åï¼ŒoldStartNodeå°±ä¼šå…ˆè¡Œå¯¹æ¯”ã€‚
```ts
function vue2Diff(prevChildren, nextChildren, parent) {
  while (oldStartIndex <= oldEndIndex && newStartIndex <= newEndIndex) {
  }
  if (oldEndIndex < oldStartIndex) {
    for (let i = newStartIndex; i <= newEndIndex; i++) {
      mount(nextChildren[i], parent, prevStartNode.el)
  }}}
```

#### 3.4 ç§»é™¤èŠ‚ç‚¹

å½“æ–°åˆ—è¡¨çš„`newEndIndex`å°äº`newStartIndex`æ—¶ï¼Œæˆ‘ä»¬å°†æ—§åˆ—è¡¨å‰©ä½™çš„èŠ‚ç‚¹åˆ é™¤å³å¯ã€‚è¿™é‡Œæˆ‘ä»¬éœ€è¦æ³¨æ„ï¼Œæ—§åˆ—è¡¨çš„undefindã€‚å½“å¤´å°¾èŠ‚ç‚¹éƒ½ä¸ç›¸åŒæ—¶ï¼Œæˆ‘ä»¬ä¼šå»æ—§åˆ—è¡¨ä¸­æ‰¾æ–°åˆ—è¡¨çš„ç¬¬ä¸€ä¸ªèŠ‚ç‚¹ï¼Œç§»åŠ¨å®ŒDOMèŠ‚ç‚¹åï¼Œå°†æ—§åˆ—è¡¨çš„é‚£ä¸ªèŠ‚ç‚¹æ”¹ä¸ºundefindã€‚æ‰€ä»¥æˆ‘ä»¬åœ¨æœ€åçš„åˆ é™¤æ—¶ï¼Œéœ€è¦æ³¨æ„è¿™äº›undefindï¼Œé‡åˆ°çš„è¯è·³è¿‡å½“å‰å¾ªç¯å³å¯ã€‚

```ts
function vue2Diff(prevChildren, nextChildren, parent) {
  while (oldStartIndex <= oldEndIndex && newStartIndex <= newEndIndex) {
  }
  if (oldEndIndex < oldStartIndex) {
    for (let i = newStartIndex; i <= newEndIndex; i++) {
      mount(nextChildren[i], parent, prevStartNode.el)
    }
  } else if (newEndIndex < newStartIndex) {
    for (let i = oldStartIndex; i <= oldEndIndex; i++) {
      if (prevChildren[i]) {
        partent.removeChild(prevChildren[i].el)
  }}}}
```


